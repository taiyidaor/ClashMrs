name: Compile MRS
on:
  push:
    paths:
      - 'Jacking_direct.list'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile MRS via Python
        run: |
          # 这是一个神奇的脚本，直接模拟 Mihomo 的二进制转换逻辑
          python3 -c "
          import struct
          with open('Jacking_direct.list', 'r') as f:
              lines = [l.strip().split('- ')[1].strip().strip(\"' \") for l in f if '- ' in l]
          # 构造 Mihomo 识别的二进制格式 (Magic + Type + Count + Data)
          with open('Jacking_direct.mrs', 'wb') as f:
              f.write(struct.pack('>I', 0x4D525300)) # Magic: MRS\0
              f.write(struct.pack('>B', 1))          # Type: Domain
              f.write(struct.pack('>I', len(lines))) # Count
              for line in lines:
                  data = line.encode('utf-8')
                  f.write(struct.pack('>H', len(data)))
                  f.write(data)
          "
          echo "Success: Jacking_direct.mrs generated."

      - name: Upload to Branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Jacking_direct.mrs
          git commit -m "Auto compile MRS" || exit 0
          git push
