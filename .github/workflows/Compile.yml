name: Compile MRS
on:
  push:
    paths:
      - 'Jacking_direct.list'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Perfect Python Compile
        run: |
          python3 -c "
          import struct
          # 1. 精准读取规则
          lines = []
          with open('Jacking_direct.list', 'r') as f:
              for line in f:
                  clean = line.strip()
                  if not clean or clean.startswith('#'): continue
                  # 兼容 '- domain.com' 和 'domain.com' 两种格式
                  if clean.startswith('- '):
                      lines.append(clean[2:].strip().strip(\"' \"))
                  else:
                      lines.append(clean.strip().strip(\"' \"))
          
          # 2. 严格按照 Mihomo 二进制规范写入
          with open('Jacking_direct.mrs', 'wb') as f:
              f.write(struct.pack('>I', 0x4D525300)) # Magic: MRS\0
              f.write(struct.pack('>B', 1))          # Type: Domain
              f.write(struct.pack('>I', len(lines))) # Count
              for line in lines:
                  data = line.encode('utf-8')
                  f.write(struct.pack('>H', len(data))) # 每个域名长度(关键!)
                  f.write(data)                         # 域名内容
          "
          echo "Build Success: MRS generated locally."

      - name: Upload
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Jacking_direct.mrs
          git commit -m "Auto-compile MRS (Python Internal)" || exit 0
          git push
